21543cf963210433e814c10b80072051
"use strict";
var __importDefault = (this && this.__importDefault) || function (mod) {
    return (mod && mod.__esModule) ? mod : { "default": mod };
};
Object.defineProperty(exports, "__esModule", { value: true });
exports.withinTransaction = exports.registerMysqlDatabase = exports.getConfig = void 0;
const path_1 = __importDefault(require("path"));
function getConfig() {
    return {
        client: "mysql2",
        connection: {
            host: "mysql",
            user: "user",
            password: "password",
            database: "db",
        },
    };
}
exports.getConfig = getConfig;
async function registerMysqlDatabase(app) {
    await app.knex.raw("SELECT 1");
    console.log("init migration");
    await app.knex.migrate.latest({
        database: "db",
        directory: path_1.default.join(__dirname, "../migrations"),
    });
    console.log("migratin done");
}
exports.registerMysqlDatabase = registerMysqlDatabase;
async function withinTransaction({ app, callback, }) {
    const trx = await app.knex.transaction();
    try {
        const data = await callback(trx);
        await trx.commit();
        return data;
    }
    catch (err) {
        await trx.rollback();
        throw new Error("database commit failed");
    }
}
exports.withinTransaction = withinTransaction;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJmaWxlIjoiL1VzZXJzL2tpbW5hY2lzY2lvbmlzL2dpdC9wZXJzb25hbC9zZWItZXhjaGFuZ2UtcmF0ZXMvc3JjL2FkYXB0ZXJzL215c3FsLWFkYXB0ZXIudHMiLCJtYXBwaW5ncyI6Ijs7Ozs7O0FBQ0EsZ0RBQXdCO0FBR3hCLFNBQWdCLFNBQVM7SUFDdkIsT0FBTztRQUNMLE1BQU0sRUFBRSxRQUFRO1FBQ2hCLFVBQVUsRUFBRTtZQUNWLElBQUksRUFBRSxPQUFPO1lBQ2IsSUFBSSxFQUFFLE1BQU07WUFDWixRQUFRLEVBQUUsVUFBVTtZQUNwQixRQUFRLEVBQUUsSUFBSTtTQUNmO0tBQ0YsQ0FBQTtBQUNILENBQUM7QUFWRCw4QkFVQztBQUVNLEtBQUssVUFBVSxxQkFBcUIsQ0FDekMsR0FBb0I7SUFFcEIsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxVQUFVLENBQUMsQ0FBQztJQUUvQixPQUFPLENBQUMsR0FBRyxDQUFDLGdCQUFnQixDQUFDLENBQUM7SUFDOUIsTUFBTSxHQUFHLENBQUMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxNQUFNLENBQUM7UUFDNUIsUUFBUSxFQUFFLElBQUk7UUFDZCxTQUFTLEVBQUUsY0FBSSxDQUFDLElBQUksQ0FBQyxTQUFTLEVBQUUsZUFBZSxDQUFDO0tBQ2pELENBQUMsQ0FBQztJQUNILE9BQU8sQ0FBQyxHQUFHLENBQUMsZUFBZSxDQUFDLENBQUM7QUFDL0IsQ0FBQztBQVhELHNEQVdDO0FBRU0sS0FBSyxVQUFVLGlCQUFpQixDQUFJLEVBQ3pDLEdBQUcsRUFDSCxRQUFRLEdBSVQ7SUFDQyxNQUFNLEdBQUcsR0FBRyxNQUFNLEdBQUcsQ0FBQyxJQUFJLENBQUMsV0FBVyxFQUFFLENBQUM7SUFFekMsSUFBSSxDQUFDO1FBQ0gsTUFBTSxJQUFJLEdBQUcsTUFBTSxRQUFRLENBQUMsR0FBRyxDQUFDLENBQUM7UUFFakMsTUFBTSxHQUFHLENBQUMsTUFBTSxFQUFFLENBQUM7UUFFbkIsT0FBTyxJQUFJLENBQUM7SUFDZCxDQUFDO0lBQUMsT0FBTyxHQUFHLEVBQUUsQ0FBQztRQUNiLE1BQU0sR0FBRyxDQUFDLFFBQVEsRUFBRSxDQUFDO1FBRXJCLE1BQU0sSUFBSSxLQUFLLENBQUMsd0JBQXdCLENBQUMsQ0FBQztJQUM1QyxDQUFDO0FBQ0gsQ0FBQztBQXBCRCw4Q0FvQkMiLCJuYW1lcyI6W10sInNvdXJjZXMiOlsiL1VzZXJzL2tpbW5hY2lzY2lvbmlzL2dpdC9wZXJzb25hbC9zZWItZXhjaGFuZ2UtcmF0ZXMvc3JjL2FkYXB0ZXJzL215c3FsLWFkYXB0ZXIudHMiXSwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgRmFzdGlmeUluc3RhbmNlIH0gZnJvbSBcImZhc3RpZnlcIjtcbmltcG9ydCBwYXRoIGZyb20gXCJwYXRoXCI7XG5pbXBvcnQgeyBLbmV4IH0gZnJvbSBcImtuZXhcIjtcblxuZXhwb3J0IGZ1bmN0aW9uIGdldENvbmZpZygpIHtcbiAgcmV0dXJuIHtcbiAgICBjbGllbnQ6IFwibXlzcWwyXCIsXG4gICAgY29ubmVjdGlvbjoge1xuICAgICAgaG9zdDogXCJteXNxbFwiLFxuICAgICAgdXNlcjogXCJ1c2VyXCIsXG4gICAgICBwYXNzd29yZDogXCJwYXNzd29yZFwiLFxuICAgICAgZGF0YWJhc2U6IFwiZGJcIixcbiAgICB9LFxuICB9XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiByZWdpc3Rlck15c3FsRGF0YWJhc2UoXG4gIGFwcDogRmFzdGlmeUluc3RhbmNlXG4pOiBQcm9taXNlPHZvaWQ+IHtcbiAgYXdhaXQgYXBwLmtuZXgucmF3KFwiU0VMRUNUIDFcIik7XG5cbiAgY29uc29sZS5sb2coXCJpbml0IG1pZ3JhdGlvblwiKTtcbiAgYXdhaXQgYXBwLmtuZXgubWlncmF0ZS5sYXRlc3Qoe1xuICAgIGRhdGFiYXNlOiBcImRiXCIsXG4gICAgZGlyZWN0b3J5OiBwYXRoLmpvaW4oX19kaXJuYW1lLCBcIi4uL21pZ3JhdGlvbnNcIiksXG4gIH0pO1xuICBjb25zb2xlLmxvZyhcIm1pZ3JhdGluIGRvbmVcIik7XG59XG5cbmV4cG9ydCBhc3luYyBmdW5jdGlvbiB3aXRoaW5UcmFuc2FjdGlvbjxUPih7XG4gIGFwcCxcbiAgY2FsbGJhY2ssXG59OiB7XG4gIGFwcDogRmFzdGlmeUluc3RhbmNlO1xuICBjYWxsYmFjazogKHRyeDogS25leC5UcmFuc2FjdGlvbikgPT4gUHJvbWlzZTxUPjtcbn0pOiBQcm9taXNlPFQ+IHtcbiAgY29uc3QgdHJ4ID0gYXdhaXQgYXBwLmtuZXgudHJhbnNhY3Rpb24oKTtcblxuICB0cnkge1xuICAgIGNvbnN0IGRhdGEgPSBhd2FpdCBjYWxsYmFjayh0cngpO1xuXG4gICAgYXdhaXQgdHJ4LmNvbW1pdCgpO1xuXG4gICAgcmV0dXJuIGRhdGE7XG4gIH0gY2F0Y2ggKGVycikge1xuICAgIGF3YWl0IHRyeC5yb2xsYmFjaygpO1xuXG4gICAgdGhyb3cgbmV3IEVycm9yKFwiZGF0YWJhc2UgY29tbWl0IGZhaWxlZFwiKTtcbiAgfVxufVxuIl0sInZlcnNpb24iOjN9